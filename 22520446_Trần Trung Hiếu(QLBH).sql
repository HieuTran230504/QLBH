CREATE DATABASE QuanLyBanHang
USE QuanLyBanHang
SET DATEFORMAT DMY;

CREATE TABLE KHACHHANG
(
	MAKH char(4) primary key,
	HOTEN varchar(40),
	DCHI varchar(50),
	SODT varchar(20),
	NGSINH smalldatetime,
	DOANHSO money,
	NGDK smalldatetime
)

CREATE TABLE NHANVIEN
(
	MANV char(4),
	HOTEN varchar(40),
	SODT varchar(20),
	NGVL smalldatetime
)
alter table NHANVIEN 
alter column MANV char(4) not null;
alter table NHANVIEN add constraint MANV primary key (MANV)

CREATE TABLE SANPHAM
(
	MASP char(4),
	TENSP varchar(40),
	DVT varchar(20),
	NUOCSX varchar(40),
	GIA money
)

CREATE TABLE HOADON
(
	SOHD int,
	NGHD smalldatetime,
	MAKH char(4),
	MANV char(4),
	TRIGIA money
)

CREATE TABLE CTHD
(
	SOHD int,
	MASP char(4),
	SL int,
	constraint PK_CTHD primary key (SOHD, MASP)
)

--Cau 2-I:
alter table SANPHAM add GHICHU varchar(20)

--Cau 3-I:
alter table KHACHHANG add LOAIKH tinyint

--Cau 4-I:
alter table SANPHAM
alter column GHICHU varchar(100);

--Cau 5-I:
alter table SANPHAM
drop column GHICHU;

--Cau 6-I:
alter table KHACHHANG
alter column LOAIKH varchar(20);

--Cau 7-I:
alter table SANPHAM 
add constraint KIEMTRA check(DVT in ('cay','hop','cai','quyen','chuc'));

--Cau 8-I: 
alter table SANPHAM
add check(GIA >= 500);

--Cau 9-I:
alter table CTHD
add check(SL >= 1);

--Cau 10-I:
alter table KHACHHANG
add constraint KT_NGAYDK check(NGDK > NGSINH)

--Cau 11-I:
--THEM, SUA HOADON
CREATE TRIGGER INS_HOADON ON HOADON
FOR INSERT, UPDATE
AS
BEGIN
	IF (SELECT COUNT(*) FROM KHACHHANG K, INSERTED I
		WHERE K.MAKH = I.MAKH AND K.NGDK > I.NGHD) > 0
	BEGIN
		PRINT 'ERRO: NGDK PHAI < NGHD'
		ROLLBACK TRAN
	END
	ELSE
	BEGIN
		PRINT 'HOA DON DA THEM THANH CONG'
	END
END

--SUA KHACHHANG
CREATE TRIGGER UDT_KHAHHANG ON KHACHHANG
FOR UPDATE
AS
BEGIN
	IF (SELECT COUNT(*) FROM HOADON K, INSERTED I
		WHERE K.MAKH = I.MAKH AND K.NGHD < I.NGDK) > 0
	BEGIN
		PRINT 'ERRO: NGDK PHAI < NGHD'
		ROLLBACK TRAN
	END
	ELSE
	BEGIN
		PRINT 'SUA KHACH HANG THANH CONG'
	END
END

--Cau 12-I:
--SUA NHANVIEN
CREATE TRIGGER UDP_NGVL_NV ON NHANVIEN
FOR UPDATE
AS
BEGIN
	IF EXISTS (SELECT * FROM HOADON INNER JOIN INSERTED ON HOADON.MANV = INSERTED.MANV
			   WHERE HOADON.NGHD < INSERTED.NGVL)
	BEGIN
		PRINT 'ERRO: NGVL PHAI <= NGHD'
		ROLLBACK TRAN
	END
	ELSE
	BEGIN
		PRINT 'SUA NHAN VIEN THANH CONG'
	END
END

--THEM VA SUA HOADON
CREATE TRIGGER INST_HOADON ON HOADON
FOR INSERT, UPDATE
AS
BEGIN
	IF EXISTS (SELECT * FROM NHANVIEN INNER JOIN INSERTED ON NHANVIEN.MANV = INSERTED.MANV
			   WHERE NHANVIEN.NGVL > INSERTED.NGHD)
	BEGIN
		PRINT 'ERRO: NGVL PHAI <= NGHD'
		ROLLBACK TRAN
	END
	ELSE
	BEGIN
		PRINT 'THEM HOA DON THANH CONG'
	END
END

--Cau 14-I:
CREATE TRIGGER TRG_CTHD ON CTHD FOR INSERT, DELETE
AS
BEGIN
	DECLARE @SOHD INT, @TONGGIA INT
	SELECT @TONGGIA = SUM(SL * GIA), @SOHD = SOHD
	FROM INSERTED INNER JOIN SANPHAM ON INSERTED.MASP = SANPHAM.MASP
	GROUP BY SOHD

	UPDATE HOADON 
	SET TRIGIA += @TONGGIA
	WHERE SOHD = @SOHD
END

CREATE TRIGGER TR_DEL_CTHD ON CTHD FOR DELETE
AS
BEGIN
	DECLARE @SOHD INT, @GIATRI INT

	SELECT @SOHD = SOHD, @GIATRI = SL * GIA 
	FROM DELETED INNER JOIN SANPHAM 
	ON SANPHAM.MASP = DELETED.MASP

	UPDATE HOADON
	SET TRIGIA -= @GIATRI
	WHERE SOHD = @SOHD
END


--INSERT KHACHHANG
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES('KH01', 'NGUYEN VAN A', '731 Tran Hung Dao, Q5, TpHCM', '08823451', '22/10/1960', 13060000, '22/07/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES('KH02', 'Tran Ngoc Han', '23/5 Nguyen Trai, Q5, TpHCM', '0908256478', '3/4/1974', 280000, '30/07/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES('KH03', 'Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, TpHCM', '0938776266', '12/6/1980', 3860000, '05/08/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES('KH04', 'Tran Minh Long', '50/34 Le Dai Hanh, Q10, TpHCM', '0917325476', '9/3/1965', 250000, '02/10/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES('KH05', 'Le Nhat Minh', '34 Truong Dinh, Q3, TpHCM', '08246108', '10/3/1950', 21000, '28/10/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES('KH06', 'Le Hoai Thuong', '227 Nguyen Van Cu, Q5, TpHCM', '08631738', '31/12/1981', 915000, '24/11/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES('KH07', 'Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, TpHCM', '0916783565', '6/4/1971', 12500, '01/12/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES('KH08', 'Phan Thi Thanh', '45/2 An Duong Vuong, Q5, TpHCM', '0938435756', '10/1/1971', 365000, '13/12/2006')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES('KH09', 'Le Ha Vinh', '873 Le Hong Phong, Q5, TpHCM', '08654763', '3/9/1979', 70000, '14/01/2007')
INSERT INTO KHACHHANG(MAKH, HOTEN, DCHI, SODT, NGSINH, DOANHSO, NGDK) VALUES('KH10', 'Ha Duy Lap', '34/34B Nguyen Trai, Q1, TpHCM', '08768904', '2/5/1983', 67500, '16/01/2007')

--INSERT NHANVIEN
INSERT INTO NHANVIEN VALUES('NV01','Nguyen Nhu Nhut', '0927345678', '13/4/2006')
INSERT INTO NHANVIEN VALUES('NV02','Le Thi Phi Yen','0987567390','21/4/2006')
INSERT INTO NHANVIEN VALUES('NV03','Nguyen Van B','0997047382','27/4/2006')
INSERT INTO NHANVIEN VALUES('NV04','Ngo Thanh Tuan','0913758498','24/6/2006')
INSERT INTO NHANVIEN VALUES('NV05','Nguyen Thi Truc Thanh','0918590387','20/7/2006')

--INSERT SANPHAM
INSERT INTO SANPHAM VALUES('BC01', 'But chi', 'cay', 'Singapore', 3000)
INSERT INTO SANPHAM VALUES('BC02', 'But chi', 'cay', 'Singapore', 5000)
INSERT INTO SANPHAM VALUES('BC03', 'But chi', 'cay', 'Viet Nam', 3500)
INSERT INTO SANPHAM VALUES('BC04', 'But chi', 'hop', 'Viet Nam', 30000)
INSERT INTO SANPHAM VALUES('BB01', 'But bi', 'cay', 'Viet Nam', 5000)
INSERT INTO SANPHAM VALUES('BB02', 'But bi', 'cay', 'Trung Quoc', 7000)
INSERT INTO SANPHAM VALUES('BB03', 'But bi', 'hop', 'Thai Lan', 100000)
INSERT INTO SANPHAM VALUES('TV01', 'Tap 100 giay mong', 'quyen', 'Trung Quoc', 2500)
INSERT INTO SANPHAM VALUES('TV02', 'Tap 200 giay mong', 'quyen', 'Trung Quoc', 4500)
INSERT INTO SANPHAM VALUES('TV03', 'Tap 100 giay tot', 'quyen', 'Viet Nam', 3000)
INSERT INTO SANPHAM VALUES('TV04', 'Tap 200 giay tot', 'quyen', 'Viet Nam', 5500)
INSERT INTO SANPHAM VALUES('TV05', 'Tap 100 trang', 'chuc', 'Viet Nam', 23000)
INSERT INTO SANPHAM VALUES('TV06', 'Tap 200 trang', 'chuc', 'Viet Nam', 53000)
INSERT INTO SANPHAM VALUES('TV07', 'Tap 100 trang', 'chuc', 'Trung Quoc', 34000)
INSERT INTO SANPHAM VALUES('ST01', 'So tay 500 trang', 'quyen', 'Trung Quoc', 40000)
INSERT INTO SANPHAM VALUES('ST02', 'So tay loai 1', 'quyen', 'Viet Nam', 55000)
INSERT INTO SANPHAM VALUES('ST03', 'So tay loai 2', 'quyen', 'Viet Nam', 51000)
INSERT INTO SANPHAM VALUES('ST04', 'So tay', 'quyen', 'Thai Lan', 55000)
INSERT INTO SANPHAM VALUES('ST05', 'So tay mong', 'quyen', 'Thai Lan', 20000)
INSERT INTO SANPHAM VALUES('ST06', 'Phan viet bang', 'hop', 'Viet Nam', 5000)
INSERT INTO SANPHAM VALUES('ST07', 'Phan khong bui', 'hop', 'Viet Nam', 7000)
INSERT INTO SANPHAM VALUES('ST08', 'Bong bang', 'cai', 'Viet Nam', 1000)
INSERT INTO SANPHAM VALUES('ST09', 'But long', 'cay', 'Viet Nam', 5000)
INSERT INTO SANPHAM VALUES('ST10', 'But long', 'cay', 'Trung Quoc', 7000)

--INSERT HOADON
INSERT INTO HOADON VALUES(1001,'23/07/2006', 'KH01','NV01', 320000)
INSERT INTO HOADON VALUES(1002,'12/08/2006', 'KH01','NV02', 840000)
INSERT INTO HOADON VALUES(1003,'23/08/2006', 'KH02','NV01', 100000)
INSERT INTO HOADON VALUES(1004,'01/09/2006', 'KH02','NV01', 180000)
INSERT INTO HOADON VALUES(1005,'20/10/2006', 'KH01','NV02', 3800000)
INSERT INTO HOADON VALUES(1006,'16/10/2006', 'KH01','NV03', 2430000)
INSERT INTO HOADON VALUES(1007,'28/10/2006', 'KH03','NV03', 510000)
INSERT INTO HOADON VALUES(1008,'28/10/2006', 'KH01','NV03', 440000)
INSERT INTO HOADON VALUES(1009,'28/10/2006', 'KH03','NV04', 200000)
INSERT INTO HOADON VALUES(1010,'01/11/2006', 'KH01','NV01', 5200000)
INSERT INTO HOADON VALUES(1011,'04/11/2006', 'KH04','NV03', 250000)
INSERT INTO HOADON VALUES(1012,'30/11/2006', 'KH05','NV03', 21000)
INSERT INTO HOADON VALUES(1013,'12/12/2006', 'KH06','NV01', 5000)
INSERT INTO HOADON VALUES(1014,'31/12/2006', 'KH03','NV02', 3150000)
INSERT INTO HOADON VALUES(1015,'01/01/2007', 'KH06','NV01', 910000)
INSERT INTO HOADON VALUES(1016,'01/01/2007', 'KH07','NV02', 12500)
INSERT INTO HOADON VALUES(1017,'02/01/2007', 'KH08','NV03', 35000)
INSERT INTO HOADON VALUES(1018,'13/01/2007', 'KH08','NV03', 330000)
INSERT INTO HOADON VALUES(1019,'13/01/2007', 'KH01','NV03', 30000)
INSERT INTO HOADON VALUES(1020,'14/01/2007', 'KH09','NV04', 70000)
INSERT INTO HOADON VALUES(1021,'16/01/2007', 'KH10','NV03', 67500)
INSERT INTO HOADON VALUES(1022,'16/01/2007', Null,'NV03', 7000)
INSERT INTO HOADON VALUES(1023,'17/01/2007', Null,'NV01', 330000)

--INSERT CTHD
INSERT INTO CTHD VALUES(1001, 'TV02', 10)
INSERT INTO CTHD VALUES(1001, 'ST01', 5)
INSERT INTO CTHD VALUES(1001, 'BC01', 5)
INSERT INTO CTHD VALUES(1001, 'BC02', 10)
INSERT INTO CTHD VALUES(1001, 'ST08', 10)
INSERT INTO CTHD VALUES(1002, 'BC04', 20)
INSERT INTO CTHD VALUES(1002, 'BB01', 20)
INSERT INTO CTHD VALUES(1002, 'BB02', 20)
INSERT INTO CTHD VALUES(1003, 'BB03', 10)
INSERT INTO CTHD VALUES(1004, 'TV01', 20)
INSERT INTO CTHD VALUES(1004, 'TV02', 10)
INSERT INTO CTHD VALUES(1004, 'TV03', 10)
INSERT INTO CTHD VALUES(1004, 'TV04', 10)
INSERT INTO CTHD VALUES(1005, 'TV05', 50)
INSERT INTO CTHD VALUES(1005, 'TV06', 50)
INSERT INTO CTHD VALUES(1006, 'TV07', 20)
INSERT INTO CTHD VALUES(1006, 'ST01', 30)
INSERT INTO CTHD VALUES(1006, 'ST02', 10)
INSERT INTO CTHD VALUES(1007, 'ST03', 10)
INSERT INTO CTHD VALUES(1008, 'ST04', 8)
INSERT INTO CTHD VALUES(1009, 'ST05', 10)
INSERT INTO CTHD VALUES(1010, 'TV07', 50)
INSERT INTO CTHD VALUES(1010, 'ST07', 50)
INSERT INTO CTHD VALUES(1010, 'ST08', 100)
INSERT INTO CTHD VALUES(1010, 'ST04', 50)
INSERT INTO CTHD VALUES(1010, 'TV03', 100)
INSERT INTO CTHD VALUES(1011, 'ST06', 50)
INSERT INTO CTHD VALUES(1012, 'ST07', 3)
INSERT INTO CTHD VALUES(1013, 'ST08', 5)
INSERT INTO CTHD VALUES(1014, 'BC02', 80)
INSERT INTO CTHD VALUES(1014, 'BB02', 100)
INSERT INTO CTHD VALUES(1014, 'BC04', 60)
INSERT INTO CTHD VALUES(1014, 'BB01', 50)
INSERT INTO CTHD VALUES(1015, 'BB02', 30)
INSERT INTO CTHD VALUES(1015, 'BB03', 7)
INSERT INTO CTHD VALUES(1016, 'TV01', 5)
INSERT INTO CTHD VALUES(1017, 'TV02', 1)
INSERT INTO CTHD VALUES(1017, 'TV03', 1)
INSERT INTO CTHD VALUES(1017, 'TV04', 5)
INSERT INTO CTHD VALUES(1018, 'ST04', 6)
INSERT INTO CTHD VALUES(1019, 'ST05', 1)
INSERT INTO CTHD VALUES(1019, 'ST06', 2)
INSERT INTO CTHD VALUES(1020, 'ST07', 10)
INSERT INTO CTHD VALUES(1021, 'ST08', 5)
INSERT INTO CTHD VALUES(1021, 'TV01', 7)
INSERT INTO CTHD VALUES(1021, 'TV02', 10)
INSERT INTO CTHD VALUES(1022, 'ST07', 1)
INSERT INTO CTHD VALUES(1023, 'ST04', 6)

--PHAN II
--CAU 2-II:
SELECT *INTO SANPHAM1 FROM SANPHAM
SELECT *INTO KHACHHANG1 FROM KHACHHANG

--CAU 3-II:
UPDATE SANPHAM1 
SET GIA = GIA * 1.05
WHERE NUOCSX = 'Thai Lan';

--CAU 4-II:
UPDATE SANPHAM1
SET GIA = GIA * 0.95
WHERE NUOCSX = 'Trung Quoc' AND GIA <= 10000; 

--CAU 5-II:
UPDATE KHACHHANG1
SET LOAIKH = 'ViP'
WHERE (NGDK < '1/1/2007' AND DOANHSO > 10000000)
OR (NGDK >= '1/1/2007' AND DOANHSO >= 2000000);


--PHAN III
--CaU 1-III:
SELECT MASP, TENSP FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc';

--CaU 2-III:
SELECT MASP, TENSP FROM SANPHAM
WHERE DVT = 'cay' OR DVT = 'quyen';

--CaU 3-III:
SELECT MASP, TENSP FROM SANPHAM
WHERE MASP LIKE 'B_01';

--CaU 4-III:
SELECT MASP, TENSP FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc' AND GIA BETWEEN 30000 AND 40000;

--CaU 5-III:
SELECT MASP, TENSP FROM SANPHAM
WHERE (NUOCSX = 'Trung Quoc' OR NUOCSX = 'Thai Lan') AND GIA BETWEEN 30000 AND 40000;

--Cau 6-III:
SELECT SOHD, TRIGIA FROM HOADON
WHERE NGHD IN('1/1/2007' ,'2/1/2007');

--Cau 7-III:
SELECT SOHD, TRIGIA FROM HOADON
WHERE MONTH(NGHD) = 1 AND YEAR(NGHD) = 2007
ORDER BY NGHD ASC, TRIGIA DESC;

--Cau 8-III:
SELECT KHACHHANG.MAKH, HOTEN 
FROM KHACHHANG INNER JOIN HOADON
ON KHACHHANG.MAKH = HOADON.MAKH
WHERE NGHD = '1/1/2007';

--Cau 9-III:
SELECT SOHD, TRIGIA 
FROM HOADON INNER JOIN NHANVIEN
ON HOADON.MANV = NHANVIEN.MANV
WHERE HOTEN = 'Nguyen Van B' AND NGHD = '28/10/2006';

--Cau 10-III:
SELECT SANPHAM.MASP, TENSP 
FROM SANPHAM INNER JOIN CTHD ON SANPHAM.MASP = CTHD.MASP
INNER JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
INNER JOIN KHACHHANG ON HOADON.MAKH = KHACHHANG.MAKH
WHERE HOTEN = 'Nguyen Van A' AND MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006;

--Cau 11-III:
SELECT DISTINCT SOHD FROM CTHD
WHERE MASP IN ('BB01', 'BB02');

--Cau 12-III:
SELECT DISTINCT SOHD FROM CTHD
WHERE MASP IN ('BB01', 'BB02') AND SL BETWEEN 10 AND 20;

--Cau 13-III:
SELECT DISTINCT SOHD FROM CTHD
WHERE MASP = 'BB01' AND SL BETWEEN 10 AND 20
INTERSECT
(
	SELECT DISTINCT SOHD FROM CTHD
	WHERE MASP = 'BB02' AND SL BETWEEN 10 AND 20
)

--Cau 14-III:
SELECT DISTINCT SANPHAM.MASP, TENSP 
FROM SANPHAM INNER JOIN CTHD ON SANPHAM.MASP = CTHD.MASP
INNER JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
WHERE SANPHAM.NUOCSX = 'Trung Quoc' OR NGHD = '1/1/2007'

--Cau 15-III:
SELECT MASP, TENSP 
FROM SANPHAM
WHERE MASP NOT IN (SELECT MASP FROM CTHD)

--Cau 16-III:
SELECT MASP, TENSP
FROM SANPHAM
WHERE MASP NOT IN
(
	SELECT MASP
	FROM CTHD INNER JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
	WHERE YEAR(NGHD) = 2006
)

--Cau 17-III:
SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc' AND MASP NOT IN
(
	SELECT CTHD.MASP 
	FROM CTHD INNER JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
	WHERE YEAR(NGHD) = 2006
)

--Cau 18-III:
SELECT SOHD
FROM HOADON
WHERE NOT EXISTS
(
	SELECT * 
	FROM SANPHAM
	WHERE NUOCSX = 'Singapore'
	AND NOT EXISTS
	(
		SELECT * FROM CTHD
		WHERE CTHD.SOHD = HOADON.SOHD
		AND CTHD.MASP = SANPHAM.MASP
	)
)

--Cau 18 CACH 2-III:
SELECT CTHD.SOHD 
FROM CTHD INNER JOIN SANPHAM ON CTHD.MASP = SANPHAM.MASP
WHERE NUOCSX = 'Singapore'
GROUP BY CTHD.SOHD
HAVING COUNT(CTHD.MASP) = (
	SELECT COUNT(MASP) 
	FROM SANPHAM 
	WHERE NUOCSX = 'Singapore'
)

--Cau 20-III:
SELECT COUNT(*)
FROM HOADON 
WHERE HOADON.MAKH IS NULL

--Cau 21-III:
SELECT COUNT (DISTINCT MASP)
FROM CTHD INNER JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
WHERE YEAR(NGHD) = 2006

--Cau 22-III:
SELECT MAX(TRIGIA) AS MAX, MIN(TRIGIA) AS MIN
FROM HOADON

--Cau 23-III:
SELECT AVG(TRIGIA) AS AVARAGE
FROM HOADON
WHERE YEAR(NGHD) = 2006

--Cau 24-III:
SELECT SUM(TRIGIA) AS DOANHTHU
FROM HOADON
WHERE YEAR(NGHD) = 2006

--Cau 25-III:
SELECT MAX(TRIGIA) AS MAX
FROM HOADON
WHERE YEAR(NGHD) = 2006

--Cau 26-III:
SELECT HOTEN
FROM KHACHHANG INNER JOIN HOADON ON KHACHHANG.MAKH = HOADON.MAKH
WHERE YEAR(NGHD) = 2006 AND 
TRIGIA = (
	SELECT MAX(TRIGIA)
	FROM HOADON
	WHERE YEAR(NGHD) = 2006
)

--Cau 27-III:
SELECT TOP 3 MAKH, HOTEN
FROM KHACHHANG 
ORDER BY DOANHSO DESC

--Cau 28-III:
SELECT MASP, TENSP
FROM SANPHAM
WHERE GIA IN (
	SELECT DISTINCT TOP 3 GIA
	FROM SANPHAM
	ORDER BY GIA DESC
)

--Cau 29-III:
SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Thai Lan' AND GIA IN (
	SELECT DISTINCT TOP 3 GIA
	FROM SANPHAM
	ORDER BY GIA DESC
)

--Cau 30-III:
SELECT MASP, TENSP
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc' AND GIA IN (
	SELECT DISTINCT TOP 3 GIA
	FROM SANPHAM
	WHERE NUOCSX = 'Trung Quoc'
	ORDER BY GIA DESC
)

SELECT MASP, TENSP
FROM (
	SELECT *, DENSE_RANK() OVER(ORDER BY GIA DESC) AS RANK
	FROM SANPHAM
	WHERE NUOCSX = 'Trung Quoc'
) AS HAHA
WHERE HAHA.RANK BETWEEN 1 AND 3

--Cau 31-III:
SELECT TOP 3 *,
DENSE_RANK() OVER(ORDER BY DOANHSO DESC) AS RANK
FROM KHACHHANG

--Cau 32-III:
SELECT COUNT(MASP)
FROM SANPHAM
WHERE NUOCSX = 'Trung Quoc'

--Cau 33-III:
SELECT NUOCSX, COUNT(*) SOLGSP
FROM SANPHAM
GROUP BY NUOCSX

--Cau 34-III:
SELECT NUOCSX, MAX(GIA) MAX , MIN(GIA) MIN, AVG(GIA) AVG
FROM SANPHAM
GROUP BY NUOCSX

--Cau 35-III:
SELECT NGHD, SUM(TRIGIA) DOANHTHU
FROM HOADON
GROUP BY NGHD

--Cau 36-III:
SELECT SANPHAM.MASP, TENSP, SUM(SL) TONGSL
FROM SANPHAM INNER JOIN CTHD ON SANPHAM.MASP = CTHD.MASP
INNER JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
WHERE MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006
GROUP BY SANPHAM.MASP, TENSP

--Cau 37-III:
SELECT MONTH(NGHD) THANG, SUM(TRIGIA) DOANHTHU
FROM HOADON
WHERE YEAR(NGHD) = 2006
GROUP BY MONTH(NGHD)

--Cau 38-III:
SELECT SOHD
FROM CTHD
GROUP BY SOHD
HAVING COUNT(DISTINCT MASP) >= 4

--Cau 39-III:
SELECT SOHD
FROM CTHD INNER JOIN SANPHAM ON CTHD.MASP = SANPHAM.MASP
WHERE NUOCSX = 'Viet Nam'
GROUP BY SOHD
HAVING COUNT(DISTINCT CTHD.MASP) >= 3

--Cau 40-III:
SELECT KHACHHANG.MAKH, HOTEN
FROM KHACHHANG INNER JOIN HOADON ON KHACHHANG.MAKH = HOADON.MAKH
GROUP BY KHACHHANG.MAKH, HOTEN
HAVING COUNT(SOHD) >= ALL(
	SELECT COUNT(SOHD)
	FROM KHACHHANG INNER JOIN HOADON ON KHACHHANG.MAKH = HOADON.MAKH
	GROUP BY KHACHHANG.MAKH, HOTEN
)

--Cau 41-III:
SELECT MONTH(NGHD) THANG
FROM HOADON
WHERE YEAR(NGHD) = 2006
GROUP BY MONTH(NGHD)
HAVING SUM(TRIGIA) >= ALL(
	SELECT SUM(TRIGIA)
	FROM HOADON
	WHERE YEAR(NGHD) = 2006
	GROUP BY MONTH(NGHD)
)

--Cau 42-III:
SELECT TOP 1 WITH TIES SANPHAM.MASP, TENSP
FROM SANPHAM INNER JOIN CTHD ON SANPHAM.MASP = CTHD.MASP
INNER JOIN HOADON ON CTHD.SOHD = HOADON.SOHD
WHERE YEAR(NGHD) = 2006
GROUP BY SANPHAM.MASP, TENSP
ORDER BY SUM(SL) 

--Cau 43-III:
SELECT SANPHAM.NUOCSX, MASP, TENSP
FROM SANPHAM JOIN(
	SELECT NUOCSX, MAX(GIA) AS GCN
	FROM SANPHAM
	GROUP BY NUOCSX
) AS GCNTN
ON SANPHAM.GIA = GCNTN.GCN AND SANPHAM.NUOCSX = GCNTN.NUOCSX

--Cau 44-III:
SELECT NUOCSX
FROM SANPHAM
GROUP BY NUOCSX
HAVING COUNT(DISTINCT GIA) >= 3

--Cau 45-III:
SELECT *
FROM KHACHHANG
WHERE MAKH IN 
(
	SELECT TOP 1 WITH TIES HOADON.MAKH
	FROM (
		SELECT TOP 10 MAKH
		FROM KHACHHANG
		ORDER BY DOANHSO DESC
	) AS TOP10 
	JOIN HOADON ON TOP10.MAKH = HOADON.MAKH
	GROUP BY HOADON.MAKH
	ORDER BY COUNT(*) DESC
) 






/*SELECT MAKH
FROM HOADON INNER JOIN CTHD ON HOADON.SOHD = CTHD.SOHD 
INNER JOIN SANPHAM ON CTHD.MASP = SANPHAM.MASP
WHERE NUOCSX = 'Singapore'
GROUP BY MAKH
HAVING COUNT (DISTINCT CTHD.MASP) = (
	SELECT COUNT(MASP) 
	FROM SANPHAM 
	WHERE NUOCSX = 'Singapore'
)

/*TIM SO HOA DON CO TRI GIA LON NHAT KHONG DUNG MAX
SELECT SOHD FROM HOADON
WHERE TRIGIA >= ALL(SELECT TRIGIA FROM HOADON)

--TIM SOHD CO TRI GIA BANG MUC TRI GIA CAO THU TU(KHONG DUNG MAX)
SELECT SOHD FROM HOADON
WHERE TRIGIA = 
(
	SELECT DISTINCT B.TRIGIA
	FROM HOADON B
	WHERE 3 = (
	SELECT COUNT(DISTINCT C.TRIGIA)
	FROM HOADON C
	WHERE C.TRIGIA > B.TRIGIA
	)
)*/

